#!/usr/bin/env ruby
require 'optparse'
require 'find'
require 'lutra'

verbose  = false
color    = STDOUT.tty?
usage    = 'Usage: lutra [OPTIONS] [PATH]'
tags     = Lutra::TAGS.dup
comments = Lutra::COMM.dup
formatter_name = :default

ARGV.options do |o|
  o.version = Lutra::VERSION
  o.banner = usage
  o.on('-t', '--tags=TAG', 'Search for custom tags') do |tag|
    tags |= [tag]
  end

  o.on('-c', '--comments=COM', 'Specify comment lines') do |com|
    comments |= [com]
  end

  o.on('-f', '--formatter=NAME', 'Use your own formatter') do |name|
    formatter_name = name.to_sym
  end

  o.on('-v', '--verbose', 'Verbose output') do
    verbose = true
  end
end

begin
  ARGV.options.parse!
  if ARGV.empty?
    paths = '.'
  else
    paths = ARGV.map { |p| File.exist? p or raise Errno::ENOENT, p ; p }
  end
rescue => e
  STDERR.puts "lutra: #{e.message}"
  STDERR.puts usage
  STDERR.puts "Try 'lutra --help' for more information"
  exit 1
end

scanner = Lutra::Scanner.new(tags: tags, comments: comments)

Find.find(*paths) do |path|
  unless paths.include?(path)
    Find.prune if File.basename(path).start_with?('.')
  end

  next if File.directory?(path)

  begin
    scanner.scan_file(path)
  rescue Errno::ENOENT => e
    STDERR.puts "lutra: #{e.message} (broken symlink?)" if verbose
  rescue => e
    STDERR.puts "lutra: #{path}: #{e.message}" if verbose
  end
end

formatter = Lutra::Formatter.new
formatter.set(formatter_name)

puts formatter.prepare(scanner.notes)

exit
